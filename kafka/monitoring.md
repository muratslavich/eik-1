# Мониторинг

* Broker
* Zookeeper
* Producer
* Consumer



Плюсы использования кафки

1. High throughput
2. Low latency
3. Fault tolerance
4. Durability - messages never lost
5. Scalability
6. Distributed
7. Real-time processing



### **ZooKeeper metrics** <a href="#strongzookeeper-metricsstrong" id="strongzookeeper-metricsstrong"></a>

| Name                       | Description                                            |
| -------------------------- | ------------------------------------------------------ |
| outstanding-requests       | The number of requests that are in the queue.          |
| avg-latency                | The response time to a client request in milliseconds. |
| num-alive-connections      | The number of clients connected to ZooKeeper.          |
| followers                  | The number of active followers.                        |
| pending-syncs              | The number of pending consumers syncs.                 |
| open-file-descriptor-count | The number of used file descriptors.                   |



Broker metrics

* Kafka system metrics
* JVM GC - CollectionCount, CollectionTime
* Host metrics

Kafka system metrics

| Name                                                                                                                                                                              | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p>UnderReplicatedPartitions<br>kafka_server_replicamanager_underreplicatedpartitions</p>                                                                                         | The number of under-replicated partitions across all topics on the broker. Under-replicated partitions metrics are a leading indicator of one or more brokers being unavailable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| IsrShrinksPerSec/IsrExpandsPerSec                                                                                                                                                 | If a broker goes down, in-sync replicas ISRs for some of the partitions shrink. When that broker is up again, ISRs are expanded once the replicas are fully caught up.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| <p><strong>ActiveControllerCount</strong><br>kafka_controller_kafkacontroller_activecontrollercount</p>                                                                           | Indicates whether the broker is active and should always be equals to 1 since there is only one broker at the same time that acts as a controller.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| <p><strong>OfflinePartitionsCount</strong><br>kafka_controller_kafkacontroller_offlinepartitionscount</p>                                                                         | The number of partitions that don’t have an active leader and are hence not writable or readable. A non-zero value indicates that brokers are not available.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| LeaderElectionRateAndTimeMs                                                                                                                                                       | A partition leader election happens when ZooKeeper is not able to connect with the leader. This metric may indicate a broker is unavailable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **UncleanLeaderElectionsPerSec**                                                                                                                                                  | A leader may be chosen from out-of-sync replicas if the broker which is the leader of the partition is unavailable and a new leader needs to be elected. This metric can indicate potential message loss.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| <p><strong>TotalTimeMs</strong><br>kafka_network_requestmetrics_totaltimems</p>                                                                                                   | The time is taken to process the message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| <p>PurgatorySize<br>kafka_server_delayedoperationpurgatory_purgatorysize_delayedoperation_fetch kafka_server_delayedoperationpurgatory_purgatorysize_delayedoperation_produce</p> | <p>The size of purgatory requests. Can help identify the main causes of the delay.<br><br>A Purgatory is a placeholder for both produce and fetch requests and can help you identify latency issues. The more requests are added to a Purgatory, the greater the delay in processing those requests. </p><p>For fetch requests, Purgatory size is high if not enough data is available for consumers to fetch because you’ve set a large value for either fetch.min.bytes or fetch.wait.max.ms.</p><p>For producer requests, this is usually a non-zero value if Producers use ack=all. If Producers set acks=-1, then all the produce requests will be kept in the Purgatory until the leader of the Partition gets an acknowledgment from all of its followers.</p> |
| <p><strong>BytesInPerSec</strong>/<strong>BytesOutPerSec</strong><br>kafka_server_Brokertopicmetrics_bytesout_total kafka_server_Brokertopicmetrics_bytesin_total</p>             | The number of data brokers received from producers and the number that consumers read from brokers. This is an indicator of the overall throughput or workload in the Kafka cluster.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| <p><strong>RequestsPerSecond</strong><br>kafka_network_requestmetrics_requests_total</p>                                                                                          | Frequency of requests from producers, consumers, and subscribers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| <p><strong>RequestQueueSize and ResponseQueueSize</strong></p><p>kafka_network_requestchannel_requestqueuesize</p><p>kafka_network_requestchannel_responsequeuesize</p>           | Both of these queues belong to the Kafka request channel. An increase in the queue size may halt the processing of requests and result in congestion, delayed response, and memory pressure on the Brokers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |



Producer metrics

| Name                                                                           | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| compression-rate-avg                                                           | Average compression rate of sent batches.                                                                                                                                                                                                                                                                                                                                                                                                                     |
| <p>response-rate<br>kafka_producer_response_rate</p>                           | This metric depicts the average number of responses sent by Brokers to Producers. A response is sent as an acknowledgment and is based on the Producer settings for ([acks](https://kafka.apache.org/documentation/#producerconfigs\_acks)) acknowledgment.                                                                                                                                                                                                   |
| <p>request-rate<br>kafka_producer_request_rate</p>                             | This metric gives you the average number of requests sent by Producers per second. A sudden spike in this metric may impact the performance of Brokers or cause an increase in latency during request processing.                                                                                                                                                                                                                                             |
| <p>request-latency-avg<br>kafka_producer_request_latency_avg</p>               | <p>Average requests latency in milliseconds.<br><br>Latency is the time taken from when Producers send a message to a Broker to when the Producer receives an acknowledgment from that Broker. Note that high latency is not always a bad thing. Most of the time, latency is related to throughput. If producers send large batch-sizes of messages and have the linger.ms set to a higher value to achieve high throughput, then latency will increase.</p> |
| <p>outgoing-byte-rate<br>kafka_producer_outgoing_byte_rate</p>                 | <p>An average number of outgoing bytes per second.<br>The average number of bytes sent by Producers per topic helps you determine which topics are the busiest; it can also be a good way to find network bottlenecks in a system.</p>                                                                                                                                                                                                                        |
| <p>io-wait-time-ns-avg <br>kafka_consumer_io_wait_time_ns_avg</p>              | The average length of time the I/O thread spent waiting for a socket (in ns).                                                                                                                                                                                                                                                                                                                                                                                 |
| <p>batch-size-avg<br>kafka_producer_batch_size_avg</p>                         | The average number of bytes sent per partition per request.                                                                                                                                                                                                                                                                                                                                                                                                   |
| <p><strong>Connection Count</strong></p><p>kafka_producer_connection_count</p> | Here, you have the total number of active connections created by Producers. This helps you determine how many Producers are being connected at a given time.                                                                                                                                                                                                                                                                                                  |



Consumer metrics

| Name                                                                           | Description                                                                                                                                                               |
| ------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| records-lag                                                                    | The number of messages consumer is behind the producer on this partition.                                                                                                 |
| <p>records-lag-max<br>kafka_consumer_records_lag_max</p>                       | Maximum record lag. Increasing value means that the consumer is not keeping up with the producers.                                                                        |
| <p>bytes-consumed-rate<br>kafka_consumer_bytes_consumed_rate</p>               | Average bytes consumed per second for each consumer for a specific topic or across all topics.                                                                            |
| <p>records-consumed-rate<br>kafka_consumer_records_consumed_rate</p>           | An average number of records consumed per second for a specific topic or across all topics.                                                                               |
| <p>fetch-rate<br>kafka_consumer_fetch_rate</p>                                 | The number of fetch requests per second from the consumer.                                                                                                                |
| <p><strong>Connection Count</strong></p><p>kafka_consumer_connection_count</p> | Connection Count gives you the total number of active connections created by consumers, which helps you determine how many Consumers are being connected at a given time. |

\
